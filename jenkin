pipeline {
  agent any
  environment {
  	AQUA_SECRET=credentials('AQUA_SECRET')
	AQUA_KEY=credentials('AQUA_KEY')
	PROVIDER_CREDENTIAL=credentials('PROVIDER_CREDENTIAL')
  }
  stages {
     stage('Build') {
       steps { 
          sh 'docker build -t nilotpalgure1998/dvga:latest .'
       }
     }
     
     stage('Scan') {
     	steps {
	   withCredentials([
              string(credentialsId: 'AQUA_KEY', variable: 'AQUA_KEY'),
              string(credentialsId: 'AQUA_SECRET', variable: 'AQUA_SECRET'),
	      usernamePassword(credentialsId: 'PROVIDER_CREDENTIAL', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD')
	   ]) {
	    sh 'trivy image --severity HIGH,CRITICAL nilotpalgure1998/dvga:latest'
	   }
        }
     }
  }
  post {
  	failure {
	     emailext body: 'Check console output at $BUILD_URL to view the result. \n\n ${CHANGES} \n\n -------------------\n${BUILD_LOG, maxLines=100, escapeHtml=false}',
	     to: 'nilotpalguresurvey@gmail.com',
	     subject: 'Build failure in Jenkins: $PROJECT_NAME - #$BUILD_NUMBER'
	}
	unstable {
	     emailext body: 'Check console output at $BUILD_URL to view the result. \n\n ${CHANGES} \n\n -------------------\n${BUILD_LOG, maxLines=100, escapeHtml=false}',
	     to: 'nilotpalguresurvey@gmail.com',
	     subject: 'Build is unstable in Jenkins: $PROJECT_NAME - #$BUILD_NUMBER'
	}
  }
}
